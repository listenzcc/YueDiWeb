<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSS æ–‡ä»¶ä¸Šä¼ ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        nav {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e9ecef;
        }

        nav button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        nav button:hover {
            background: #5a67d8;
        }

        .content {
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }

        button:hover {
            background: #5a67d8;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: border-color 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .progress-container {
            margin-top: 20px;
        }

        .progress-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            width: 0%;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .file-info {
            flex: 1;
        }

        .file-actions button {
            margin-left: 10px;
            padding: 6px 12px;
            font-size: 14px;
        }

        .message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #e9ecef;
            border-radius: 6px;
        }

        .storage-info {
            flex: 1;
        }

        .storage-bar {
            height: 10px;
            background: #dee2e6;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }

        .storage-used {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ“ OSS æ–‡ä»¶ä¸Šä¼ ç®¡ç†ç³»ç»Ÿ</h1>
            <p>å®‰å…¨é«˜æ•ˆçš„å¤§æ–‡ä»¶ä¸Šä¼ è§£å†³æ–¹æ¡ˆ</p>
        </header>

        <nav>
            <button onclick="showSection('auth')">ç™»å½•/æ³¨å†Œ</button>
            <button onclick="showSection('upload')" id="uploadBtn" class="hidden">ä¸Šä¼ æ–‡ä»¶</button>
            <button onclick="showSection('files')" id="filesBtn" class="hidden">æ–‡ä»¶ç®¡ç†</button>
            <button onclick="showSection('profile')" id="profileBtn" class="hidden">ä¸ªäººä¸­å¿ƒ</button>
            <button onclick="logout()" id="logoutBtn" class="hidden" style="background: #e53e3e;">é€€å‡ºç™»å½•</button>
        </nav>

        <div class="content">
            <!-- è®¤è¯åŒºåŸŸ -->
            <div id="authSection" class="card">
                <h2 style="margin-bottom: 20px;">ç”¨æˆ·ç™»å½• / æ³¨å†Œ</h2>
                <div id="authMessage" class="message hidden"></div>

                <div id="loginForm">
                    <div class="form-group">
                        <label>é‚®ç®±</label>
                        <input type="email" id="loginEmail" placeholder="è¾“å…¥é‚®ç®±">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="loginPassword" placeholder="è¾“å…¥å¯†ç ">
                    </div>
                    <button onclick="login()">ç™»å½•</button>
                    <button onclick="showRegister()" style="background: #48bb78; margin-left: 10px;">æ³¨å†Œæ–°è´¦æˆ·</button>
                </div>

                <div id="registerForm" class="hidden">
                    <div class="form-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="regUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label>é‚®ç®±</label>
                        <input type="email" id="regEmail" placeholder="è¾“å…¥é‚®ç®±">
                    </div>
                    <div class="form-group">
                        <label>å¯†ç </label>
                        <input type="password" id="regPassword" placeholder="è‡³å°‘6ä½å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label>ç¡®è®¤å¯†ç </label>
                        <input type="password" id="regConfirmPassword" placeholder="å†æ¬¡è¾“å…¥å¯†ç ">
                    </div>
                    <button onclick="register()">æ³¨å†Œ</button>
                    <button onclick="showLogin()" style="background: #718096; margin-left: 10px;">è¿”å›ç™»å½•</button>
                </div>
            </div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div id="uploadSection" class="card hidden">
                <h2 style="margin-bottom: 20px;">ä¸Šä¼ æ–‡ä»¶</h2>
                <div id="uploadMessage" class="message hidden"></div>

                <div class="user-info">
                    <div>
                        <strong>æ¬¢è¿ï¼Œ<span id="currentUser">ç”¨æˆ·</span></strong>
                        <div id="storageStatus">å­˜å‚¨ç©ºé—´ï¼š0GB / 10GB</div>
                    </div>
                    <div class="storage-info">
                        <div class="storage-bar">
                            <div class="storage-used" id="storageBar"></div>
                        </div>
                    </div>
                </div>

                <div class="upload-area" id="dropArea" ondragover="handleDragOver(event)"
                    ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“¤</div>
                    <h3>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </h3>
                    <p style="color: #6c757d; margin: 10px 0;">æ”¯æŒå•ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ï¼Œæœ€å¤§ 10GB</p>
                    <input type="file" id="fileInput" multiple style="display: none;"
                        onchange="handleFileSelect(event)">
                    <button onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                </div>

                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div id="progressText">å‡†å¤‡ä¸Šä¼ ...</div>
                </div>

                <div id="fileList" class="file-list"></div>
            </div>

            <!-- æ–‡ä»¶ç®¡ç†åŒºåŸŸ -->
            <div id="filesSection" class="card hidden">
                <h2 style="margin-bottom: 20px;">æ–‡ä»¶ç®¡ç†</h2>
                <div id="filesMessage" class="message hidden"></div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="searchInput" placeholder="æœç´¢æ–‡ä»¶å..." style="flex: 1;">
                    <button onclick="searchFiles()">æœç´¢</button>
                    <button onclick="refreshFiles()">åˆ·æ–°</button>
                </div>

                <div id="filesContainer">
                    åŠ è½½ä¸­...
                </div>
            </div>

            <!-- ä¸ªäººä¸­å¿ƒåŒºåŸŸ -->
            <div id="profileSection" class="card hidden">
                <h2 style="margin-bottom: 20px;">ä¸ªäººä¸­å¿ƒ</h2>
                <div id="profileMessage" class="message hidden"></div>

                <div class="user-info" style="margin-bottom: 30px;">
                    <div>
                        <strong id="profileUsername">ç”¨æˆ·å</strong>
                        <div id="profileEmail">é‚®ç®±ï¼šåŠ è½½ä¸­...</div>
                    </div>
                </div>

                <h3 style="margin-bottom: 15px;">ä¿®æ”¹å¯†ç </h3>
                <div class="form-group">
                    <label>å½“å‰å¯†ç </label>
                    <input type="password" id="currentPassword" placeholder="è¾“å…¥å½“å‰å¯†ç ">
                </div>
                <div class="form-group">
                    <label>æ–°å¯†ç </label>
                    <input type="password" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
                </div>
                <div class="form-group">
                    <label>ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" id="confirmNewPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>
                <button onclick="changePassword()">ä¿®æ”¹å¯†ç </button>
            </div>
        </div>
    </div>

    <!-- Download the script to the local -->
    <!-- <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.17.1.min.js"></script> -->
    <script src="/js/aliyun-oss-sdk-6.17.1.min.js"></script>
    <script>
        let currentUser = null;
        let stsCredentials = null;
        let ossClient = null;

        // æ˜¾ç¤º/éšè—åŒºåŸŸ
        function showSection(section) {
            document.querySelectorAll('.card').forEach(el => el.classList.add('hidden'));
            document.getElementById(section + 'Section').classList.remove('hidden');
        }

        // æ˜¾ç¤ºæ³¨å†Œè¡¨å•
        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('authMessage').classList.add('hidden');
        }

        // æ˜¾ç¤ºç™»å½•è¡¨å•
        function showLogin() {
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('authMessage').classList.add('hidden');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `message ${type}`;
            element.classList.remove('hidden');

            if (type === 'success') {
                setTimeout(() => element.classList.add('hidden'), 3000);
            }
        }

        // ç™»å½•
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('authMessage', 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ç™»å½•å¤±è´¥');
                }

                currentUser = data.user;
                localStorage.setItem('token', data.token);

                showMessage('authMessage', 'ç™»å½•æˆåŠŸï¼', 'success');

                // æ›´æ–°ç•Œé¢
                updateUserInterface();
                showSection('upload');

                // è·å–å­˜å‚¨ä¿¡æ¯
                updateStorageInfo();
            } catch (error) {
                showMessage('authMessage', error.message, 'error');
            }
        }

        // æ³¨å†Œ
        async function register() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;

            if (!username || !email || !password) {
                showMessage('authMessage', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage('authMessage', 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'æ³¨å†Œå¤±è´¥');
                }

                showMessage('authMessage', 'æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•', 'success');
                showLogin();
            } catch (error) {
                showMessage('authMessage', error.message, 'error');
            }
        }

        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateUserInterface() {
            const token = localStorage.getItem('token');

            if (token && currentUser) {
                document.getElementById('currentUser').textContent = currentUser.username;
                document.getElementById('profileUsername').textContent = currentUser.username;
                document.getElementById('profileEmail').textContent = `é‚®ç®±ï¼š${currentUser.email}`;

                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('uploadBtn').classList.remove('hidden');
                document.getElementById('filesBtn').classList.remove('hidden');
                document.getElementById('profileBtn').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
            }
        }

        // æ›´æ–°å­˜å‚¨ä¿¡æ¯
        async function updateStorageInfo() {
            if (!currentUser) return;

            const usedGB = (currentUser.usedStorage / 1024 / 1024 / 1024).toFixed(2);
            const totalGB = (currentUser.storageQuota / 1024 / 1024 / 1024).toFixed(0);
            const percentage = (currentUser.usedStorage / currentUser.storageQuota * 100).toFixed(1);

            document.getElementById('storageStatus').textContent =
                `å­˜å‚¨ç©ºé—´ï¼š${usedGB}GB / ${totalGB}GB`;
            document.getElementById('storageBar').style.width = `${percentage}%`;
        }

        // è·å– STS Token
        async function getSTSToken() {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch('/api/oss/sts-token', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'è·å–ä¸Šä¼ å‡­è¯å¤±è´¥');
                }

                stsCredentials = data;
                return data;
            } catch (error) {
                showMessage('uploadMessage', error.message, 'error');
                throw error;
            }
        }

        // åˆå§‹åŒ– OSS å®¢æˆ·ç«¯
        async function initOSSClient() {
            if (!stsCredentials) {
                await getSTSToken();
            }

            ossClient = new OSS({
                region: stsCredentials.region,
                accessKeyId: stsCredentials.accessKeyId,
                accessKeySecret: stsCredentials.accessKeySecret,
                stsToken: stsCredentials.stsToken,
                bucket: stsCredentials.bucket,
                refreshSTSToken: async () => {
                    const newToken = await getSTSToken();
                    return {
                        accessKeyId: newToken.accessKeyId,
                        accessKeySecret: newToken.accessKeySecret,
                        stsToken: newToken.stsToken
                    };
                },
                refreshSTSTokenInterval: 300000 // 5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
            });
        }

        // æ‹–æ”¾äº‹ä»¶å¤„ç†
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
            document.getElementById('dropArea').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropArea').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropArea').classList.remove('dragover');

            const files = e.dataTransfer.files;
            uploadFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            uploadFiles(files);
        }

        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFiles(files) {
            if (!files.length) return;

            try {
                await initOSSClient();

                document.getElementById('progressContainer').style.display = 'block';
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('progressText').textContent = 'å‡†å¤‡ä¸Šä¼ ...';

                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    await uploadSingleFile(file, i + 1, files.length);
                }

                showMessage('uploadMessage', 'æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼', 'success');

                // æ›´æ–°å­˜å‚¨ä¿¡æ¯
                updateStorageInfo();
            } catch (error) {
                showMessage('uploadMessage', error.message, 'error');
            } finally {
                document.getElementById('progressContainer').style.display = 'none';
            }
        }

        // ä¸Šä¼ å•ä¸ªæ–‡ä»¶
        async function uploadSingleFile(file, current, total) {
            return new Promise(async (resolve, reject) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <strong>${file.name}</strong>
                        <div style="color: #6c757d; font-size: 14px;">
                            å¤§å°ï¼š${formatFileSize(file.size)}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button onclick="downloadFile('${file.name}')">ä¸‹è½½</button>
                        <button onclick="deleteFile('${file.name}')" style="background: #e53e3e;">åˆ é™¤</button>
                    </div>
                `;

                document.getElementById('fileList').appendChild(fileItem);

                const objectKey = `${stsCredentials.userPath}${Date.now()}_${file.name}`;

                try {
                    const result = await ossClient.multipartUpload(objectKey, file, {
                        parallel: 4,
                        partSize: 5 * 1024 * 1024, // 5MB
                        progress: (percentage) => {
                            const progress = (percentage * 100).toFixed(1);
                            document.getElementById('progressText').textContent =
                                `ä¸Šä¼ ä¸­ (${current}/${total}): ${progress}%`;
                            document.getElementById('progressFill').style.width = `${progress}%`;
                        },
                        checkpoint: true
                    });

                    resolve(result);
                } catch (error) {
                    fileItem.classList.add('error');
                    reject(error);
                }
            });
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // è·å–æ–‡ä»¶åˆ—è¡¨
        async function getFileList() {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch('/api/oss/files', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                }

                displayFiles(data.files);
            } catch (error) {
                showMessage('filesMessage', error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function displayFiles(files) {
            const container = document.getElementById('filesContainer');

            if (!files || files.length === 0) {
                container.innerHTML = '<p>æš‚æ— æ–‡ä»¶</p>';
                return;
            }

            let html = '<div class="file-list">';

            files.forEach(file => {
                const fileName = file.name.split('/').pop();
                const fileSize = formatFileSize(file.size);
                const date = new Date(file.lastModified).toLocaleString();

                html += `
                    <div class="file-item">
                        <div class="file-info">
                            <strong>${fileName}</strong>
                            <div style="color: #6c757d; font-size: 14px;">
                                ${fileSize} â€¢ ${date}
                            </div>
                        </div>
                        <div class="file-actions">
                            <button onclick="window.open('${file.url}')">ä¸‹è½½</button>
                            <button onclick="shareFile('${file.name}')" style="background: #38a169;">åˆ†äº«</button>
                            <button onclick="deleteServerFile('${file.name}')" style="background: #e53e3e;">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // æœç´¢æ–‡ä»¶
        function searchFiles() {
            const keyword = document.getElementById('searchInput').value;
            // è¿™é‡Œå¯ä»¥å®ç°æ–‡ä»¶æœç´¢åŠŸèƒ½
            showMessage('filesMessage', 'æœç´¢åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        function refreshFiles() {
            getFileList();
        }

        // åˆ†äº«æ–‡ä»¶
        async function shareFile(objectKey) {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch('/api/oss/presigned-url', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ objectKey })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥');
                }

                navigator.clipboard.writeText(data.url);
                alert('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\né“¾æ¥24å°æ—¶å†…æœ‰æ•ˆã€‚');
            } catch (error) {
                alert('ç”Ÿæˆåˆ†äº«é“¾æ¥å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ é™¤æœåŠ¡å™¨æ–‡ä»¶
        async function deleteServerFile(objectKey) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) return;

            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`/api/oss/file/${encodeURIComponent(objectKey)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
                }

                showMessage('filesMessage', 'æ–‡ä»¶åˆ é™¤æˆåŠŸ', 'success');
                refreshFiles();
                updateStorageInfo();
            } catch (error) {
                showMessage('filesMessage', error.message, 'error');
            }
        }

        // ä¿®æ”¹å¯†ç 
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                showMessage('profileMessage', 'è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showMessage('profileMessage', 'ä¸¤æ¬¡æ–°å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('profileMessage', 'æ–°å¯†ç è‡³å°‘éœ€è¦6ä½', 'error');
                return;
            }

            const token = localStorage.getItem('token');

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'ä¿®æ”¹å¯†ç å¤±è´¥');
                }

                showMessage('profileMessage', 'å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'success');

                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
            } catch (error) {
                showMessage('profileMessage', error.message, 'error');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('token');
            currentUser = null;
            stsCredentials = null;
            ossClient = null;

            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('uploadBtn').classList.add('hidden');
            document.getElementById('filesBtn').classList.add('hidden');
            document.getElementById('profileBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');

            showSection('auth');
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = async function () {
            const token = localStorage.getItem('token');

            if (token) {
                try {
                    const response = await fetch('/api/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        currentUser = data.user;
                        updateUserInterface();
                        showSection('upload');
                        updateStorageInfo();
                    } else {
                        localStorage.removeItem('token');
                    }
                } catch (error) {
                    localStorage.removeItem('token');
                }
            }
        };
    </script>
</body>

</html>